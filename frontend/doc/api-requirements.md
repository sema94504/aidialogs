# Функциональные требования к Dashboard API

## Обзор

API предоставляет статистику по диалогам пользователей с Telegram ботом для отображения в веб-дашборде.

**Референс UI:** [shadcn dashboard-01](https://ui.shadcn.com/blocks#dashboard-01)

## Источник данных

**База данных:** SQLite с таблицами:
- `users`: id, telegram_id, created_at, deleted_at
- `messages`: id, user_id, role, content, length, created_at, deleted_at

## Функциональные требования

### 1. Ключевые метрики (Metrics Cards)

#### 1.1 Всего пользователей
- **Значение:** Количество уникальных пользователей в системе
- **Расчет:** COUNT(DISTINCT telegram_id) WHERE deleted_at IS NULL
- **Тип:** Integer

#### 1.2 Всего сообщений
- **Значение:** Общее количество сообщений (user + assistant)
- **Расчет:** COUNT(*) FROM messages WHERE deleted_at IS NULL
- **Тип:** Integer

#### 1.3 Активных пользователей сегодня
- **Значение:** Пользователи с сообщениями за последние 24 часа
- **Расчет:** COUNT(DISTINCT user_id) WHERE created_at >= NOW() - 24h AND deleted_at IS NULL
- **Тип:** Integer

#### 1.4 Средняя длина сообщения
- **Значение:** Средний размер сообщений пользователей (роль = user)
- **Расчет:** AVG(length) WHERE role = 'user' AND deleted_at IS NULL
- **Тип:** Float (округление до 1 знака)

### 2. График активности (Activity Chart)

#### 2.1 Данные
- **Период:** Последние 7 дней
- **Агрегация:** Количество сообщений по дням
- **Формат:** Массив объектов [{date, count}, ...]
- **Сортировка:** По дате (от старых к новым)

#### 2.2 Структура точки данных
- `date`: Дата в формате ISO (YYYY-MM-DD)
- `count`: Количество сообщений за день (Integer)

### 3. Последние сообщения (Recent Messages)

#### 3.1 Данные
- **Количество:** 10 последних сообщений
- **Сортировка:** По дате создания (от новых к старым)
- **Фильтр:** Только непомеченные как удаленные

#### 3.2 Структура записи
- `telegram_id`: ID пользователя в Telegram (Integer)
- `role`: Роль отправителя - "user" | "assistant" (String)
- `preview`: Превью текста сообщения, первые 100 символов (String)
- `created_at`: Дата и время создания в формате ISO 8601 (String)

## API Контракт

### Endpoint

```
GET /api/stats
```

### Response

**HTTP Status:** 200 OK

**Content-Type:** application/json

**Schema:**
```json
{
  "metrics": {
    "total_users": 42,
    "total_messages": 1337,
    "active_today": 5,
    "avg_message_length": 87.5
  },
  "activity_chart": [
    {"date": "2025-10-11", "count": 45},
    {"date": "2025-10-12", "count": 67},
    {"date": "2025-10-13", "count": 89},
    {"date": "2025-10-14", "count": 34},
    {"date": "2025-10-15", "count": 56},
    {"date": "2025-10-16", "count": 78},
    {"date": "2025-10-17", "count": 92}
  ],
  "recent_messages": [
    {
      "telegram_id": 123456789,
      "role": "user",
      "preview": "Как настроить систему?",
      "created_at": "2025-10-17T10:30:00Z"
    },
    {
      "telegram_id": 123456789,
      "role": "assistant",
      "preview": "Для настройки системы выполните следующие шаги...",
      "created_at": "2025-10-17T10:30:05Z"
    }
  ]
}
```

## Нефункциональные требования

### Производительность
- Время ответа: < 500ms для Mock API
- Время ответа: < 2s для Real API

### Безопасность
- Нет аутентификации на этапе MVP
- API доступен только из локальной сети

### Документация
- Автоматическая генерация OpenAPI/Swagger спецификации
- Доступна по адресу `/docs` (Swagger UI) и `/redoc` (ReDoc)

## Реализация

### Фаза 1: Mock API
- Генерация синтетических данных
- Реалистичные значения для демонстрации UI
- Без подключения к реальной БД

### Фаза 2: Real API (Sprint FS5)
- Подключение к существующей SQLite БД
- Реальные SQL запросы
- Кэширование результатов (опционально)

## Принципы проектирования

1. **KISS:** Один endpoint для всех данных дашборда
2. **Расширяемость:** Интерфейс StatCollector для смены реализаций
3. **Асинхронность:** Все операции async/await
4. **Типизация:** Полная типизация через Pydantic модели

